<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{An R Markdown Vignette with knitr}
-->
```{r setup, include=FALSE}
library(knitr)
library(PGMscore)
require(igraph)
library(ggplot2)
```

## PGMscore tutorial
A factorgraph consists of variables and factors. 

```{r echo=TRUE, warning=FALSE}
varDim <- rep(4,6)
facPot <- c(list(matrix(0.25,1,4)),
            list(matrix(0.25,4,4)),
            list(matrix(0.25,4,4)),
            list(matrix(0.25,4,4)),
            list(matrix(0.25,4,4)),
            list(matrix(0.25,4,4)))
facNbs <- c(list(c(1L)),
            list(c(1L,2L)),
            list(c(1L,3L)),
            list(c(3L,4L)),
            list(c(3L,5L)),
            list(c(5L,6L)) )
facNames = c("Prior",rep("Int",5))
varNames = c("Tobias","Oscar","Mette","Camilla","Sine","Maja")
mydfg <- dfg(varDim, facPot, facNbs, varNames, facNames)
```

If you have `igraph` installed the structure of the graph can be plotted using `plot`
```{r}
plot(mydfg)
```

#### Tail approximation
Suppose we have two models with the same graph structure, but different factor potentials. We can define a score of an observation as the loglikelihoodratio
$$
S(x) = \log \frac{\prod_{\mathcal{A}}f_a^\prime(x_a)}{\prod_{\mathcal{A}}f_a(x_a)} = \sum_{\mathcal{A}} \left[\log f_a^\prime(x_a) - \log f_a(x_a)\right]
$$

Motivate by bayesian statistics...

Lets define a foreground model where the variables are correlated with the ancestors
```{r}
rndDist <- function(row,col){
  x <- rexp(row*col,1/(c(1:row)+2))
  mat <- matrix(x, row, col, byrow = T)
  mat/rowSums(mat)
}
set.seed(1)
facPotFg <- c(list(rndDist(1,4)),
              list(rndDist(4,4)),
              list(rndDist(4,4)),
              list(rndDist(4,4)),
              list(rndDist(4,4)),
              list(rndDist(4,4)))
```

Lets calculate the tail probabilities in different points using the saddlepoint approximation
```{r}
saddlePointTails(3, mydfg, facPotFg)
x <- seq(-3,4,by=0.01)
cdf_upper_tail <- sapply(x,FUN=saddlePointTails, dfg=mydfg, facPotFg=facPotFg)
df_tail <- data.frame(x = x, tailSaddle = cdf_upper_tail)

library(ggplot2)
ggplot(df_tail, aes(x=x,y=tailSaddle)) + geom_line() +
  theme_bw() + 
  scale_y_log10() +
  ylab("p-value") + 
  xlab("score") +
  ggtitle("Saddlepoint approximation of the upper tail")
```

Simulation of tail
```{r}
sampleIS <- rpgmscore(1000, 0, mydfg, facPotFg)

cdf_upper_tail <- sapply(x, function(x){
  obs <- sampleIS$weights*(sampleIS$scores > x)
  error <- qnorm(0.975)*sd(obs)/sqrt(1000)
  meanobs <- mean(obs)
  c(meanobs-error, meanobs, meanobs+error)
  })
df_tail$tailNaiveLow <- pmax(cdf_upper_tail[1,], 0.0001)
df_tail$tailNaive <- cdf_upper_tail[2,]
df_tail$tailNaiveHigh <- cdf_upper_tail[3,]

sampleIS <- rpgmscore(1000, 1.5, mydfg, facPotFg)

cdf_upper_tail <- sapply(x, function(x){
  obs <- sampleIS$weights*(sampleIS$scores > x)
  error <- qnorm(0.975)*sd(obs)/sqrt(1000)
  meanobs <- mean(obs)
  c(meanobs-error, meanobs, meanobs+error)
  })
df_tail$tailISLow <- pmax(cdf_upper_tail[1,], 0.0001)
df_tail$tailIS <- cdf_upper_tail[2,]
df_tail$tailISHigh <- cdf_upper_tail[3,]

library(ggplot2)
ggplot(df_tail, aes(x=x)) + geom_line(aes(y=tailSaddle),linetype="longdash") +
  geom_line(aes(y=tailNaive), colour="blue") +
  geom_line(aes(y=tailIS), colour="red") +
  geom_ribbon(aes(ymin=tailNaiveLow,ymax=tailNaiveHigh),alpha=0.3,fill="blue") +
  geom_ribbon(aes(ymin=tailISLow,ymax=tailISHigh),alpha=0.3,fill="red") +
  theme_bw() + 
  scale_y_log10() +
  ylab("p-value") + 
  xlab("score") +
  ggtitle("Estimates of uppertail of score function") +
  annotation_logticks(sides="l")
```


